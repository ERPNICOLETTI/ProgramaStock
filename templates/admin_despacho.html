{% extends "base.html" %}
{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; flex-wrap: wrap; gap: 20px;">
        <div>
            <h1 style="margin: 0; color: #8e44ad;">üß† Admin: Control & Despacho</h1>
            <p style="margin: 5px 0 0 0; color: #7f8c8d;">Gesti√≥n unificada y liberaci√≥n de √≥rdenes.</p>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
            <a href="/ordenes/manual" class="btn" style="background: #27ae60; color: white;">
                üìù Cargar Manual
            </a>
            <a href="/ordenes/manual_tn" class="btn" style="background: #2980b9; color: white;">
                üõçÔ∏è Cargar TN
            </a>
            <button class="btn" style="background:#e67e22; color:white;" onclick="abrirModalFull()">
                üì¶ Cargar Env√≠o FULL
            </button>

            <button class="btn" style="background:#8e44ad; color:white;" onclick="abrirModalCorreccion()">
            üîç Escanear / Gestionar
                </button>
            
            <div class="dropdown" style="display: inline-block;">
                <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" style="background: #34495e; color: white;">
                    üíæ Maestros
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="importarDatos('catalogo')">üì¶ Art√≠culos</a></li>
                    <li><a class="dropdown-item" href="#" onclick="importarDatos('clientes')">üë• Clientes</a></li>
                    <li><a class="dropdown-item" href="#" onclick="importarDatos('proveedores')">üöõ Proveedores</a></li>
                </ul>
            </div>

            <a href="{{ url_for('admin.admin_logout') }}" class="btn" style="background: #95a5a6; color: white;">Salir</a>

        </div>
    </div>

    {% if not ordenes %}
        <div class="card" style="text-align: center; padding: 50px;">
            <div style="font-size: 3rem;">üéâ</div><h3 style="color: #7f8c8d;">Todo al d√≠a. No hay bloqueos.</h3>
        </div>
    {% endif %}

    <div style="display: grid; gap: 20px;">
        {% for orden in ordenes %}
        <div class="card" style="position: relative; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; border: 1px solid #e1e4e8;">
            
            <button onclick="eliminarOrden('{{ orden.id }}', '{{ orden.cliente_nombre }}')" 
                    style="position: absolute; top: 10px; right: 10px; border: none; background: none; color: #c0392b; font-size: 1.2rem; cursor: pointer; font-weight: bold;"
                    title="Eliminar Orden Completa">
                &times;
            </button>

            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                
                <div style="flex: 1; min-width: 200px;">
                    <span style="background: #2c3e50; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">{{ orden.origen }}</span>
                    <h3 style="margin: 5px 0 0 0; color: #2c3e50;">{{ orden.cliente_nombre }}</h3>
                    <div style="color: #7f8c8d; font-weight: bold;">{{ orden.numero_orden }}</div>
                    <div style="font-size: 0.85rem; color: #95a5a6; margin-top: 5px;">Esperando: {{ orden.tiempo_espera|default('Reciente') }}</div>
                </div>

                <div class="medidas" style="flex: 2; min-width: 350px; border-left: 2px solid #ecf0f1; padding-left: 15px;">
                    <h4 style="margin-top:0; color:#2980b9;">üì¶ BULTOS Y ETIQUETAS</h4>
                    
                    {% set lista_paquetes = orden.obtener_paquetes() %}

                    {% if lista_paquetes %}
                        <div id="form-bultos-{{ orden.id }}">
                            {% for p in lista_paquetes %}
                            <div style="background:#f9f9f9; padding:8px; border-radius:4px; border:1px solid #ddd; margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                                
                                <div style="font-size:0.85rem;">
                                    <strong style="color:#2c3e50;">B{{ loop.index }}:</strong> {{ p.peso }}kg 
                                    <span style="color:#7f8c8d; font-size:0.75rem;">({{ p.largo }}x{{ p.ancho }}x{{ p.alto }})</span>
                                </div>

                                {% if orden.estado == 'ESPERANDO_ADMIN' %}
                                    <input type="file" 
                                           class="input-etiqueta-bulto" 
                                           data-orden="{{ orden.id }}" 
                                           data-index="{{ loop.index0 }}" 
                                           accept="application/pdf"
                                           style="width: 200px; font-size: 0.8rem;">
                                {% else %}
                                    {% if p.etiqueta_url %}
                                        <a href="{{ p.etiqueta_url }}" target="_blank" style="text-decoration:none; font-size:0.9rem;">‚úÖ Ver PDF</a>
                                    {% else %}
                                        <span style="color:#e74c3c; font-size:0.8rem;">Pendiente</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        {% if orden.origen == 'MANUAL' and orden.estado == 'ESPERANDO_ADMIN' %}
                        <div style="text-align:right; margin-top:10px;">
                            <button class="btn" style="background: #27ae60; color: white;" onclick="guardarEtiquetasDesglosadas('{{ orden.id }}', '{{ lista_paquetes|length }}')">
                                üíæ GUARDAR Y LIBERAR ORDEN
                            </button>
                        </div>
                        {% endif %}

                    {% else %}
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                {% if orden.peso and orden.peso > 0 %}
                                    <p style="margin:0;"><strong>Peso Total:</strong> {{ orden.peso }} kg</p>
                                    <p style="margin:5px 0 0 0; font-size:0.85rem; color:#7f8c8d;">Dim: {{ orden.largo }}x{{ orden.ancho }}x{{ orden.alto }}</p>
                                {% else %}
                                    <p style="color:#c0392b; font-weight:bold;">‚ö†Ô∏è Medidas no cargadas</p>
                                {% endif %}
                            </div>

                            <div style="text-align:right; width: 50%;">
                                <input type="file" id="file-eti-{{ orden.id }}" accept="application/pdf" multiple style="width: 100%; border: 1px solid #ccc; margin-bottom: 5px; font-size:0.8rem;" placeholder="Seleccionar PDFs...">
                                
                                {% if orden.origen == 'MANUAL' and orden.estado == 'ESPERANDO_ADMIN' %}
                                    <button class="btn" style="background: #27ae60; color: white; width: 100%; font-size:0.85rem;" data-id="{{ orden.id }}" onclick="subirEtiquetaManual(this)">
                                        üè∑Ô∏è CARGAR Y DEVOLVER
                                    </button>
                                {% else %}
                                    <button class="btn" style="background: #bdc3c7; color: #2c3e50; width: 100%; cursor: not-allowed; font-size:0.85rem;" disabled>
                                        ‚õî Esperando operario
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div> </div> {% endfor %}
    </div>
</div>

<div id="modal-full" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999;">
    <div style="background:white; width:450px; margin:10% auto; padding:25px; border-radius:10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h3 style="color:#27ae60; margin-top:0;">üì¶ Cargar Env√≠o FULL (Excel/CSV)</h3>
        
        <label style="font-weight:bold; display:block; margin-bottom:5px;">Seleccionar Archivo:</label>
        <input type="file" id="full-archivo" accept=".csv, .xlsx, .xls" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">
        
        <p style="font-size:0.8rem; color:#7f8c8d; margin-bottom:15px;">
            El sistema procesar√° el archivo para dar de baja stock o mover a dep√≥sito FULL.
        </p>

        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn" onclick="cerrarModalFull()" style="background:#95a5a6; color:white;">Cancelar</button>
            <button class="btn" id="btn-confirmar-full" style="background:#27ae60; color:white;" onclick="confirmarFull()">üì§ Procesar Archivo</button>
        </div>
    </div>
</div>

<div id="modal-correccion" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999;">
    <div style="background:white; width:600px; margin:5% auto; padding:25px; border-radius:10px; border: 3px solid #8e44ad; max-height: 80vh; overflow-y: auto;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
            <h3 style="color:#8e44ad; margin:0;">üîç Gesti√≥n de C√≥digos y Vinculaciones</h3>
            <button onclick="document.getElementById('modal-correccion').style.display='none'" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        
        <p style="color:#7f8c8d; font-size:0.9rem;">Escane√° un <b>SKU</b>, <b>EAN</b> o un <b>C√≥digo de Barras</b> desconocido para ver qu√© tiene asociado.</p>
        
        <div style="display:flex; gap:10px; margin-bottom: 20px;">
            <input type="text" id="input-gestion-codigo" 
                   style="flex:1; padding:12px; font-size:1.1rem; border:1px solid #ccc; border-radius:4px;" 
                   placeholder="Escanear aqu√≠..." 
                   autofocus
                   onkeypress="if(event.key === 'Enter') buscarVinculaciones()">
            
            <button class="btn" style="background:#8e44ad; color:white;" onclick="buscarVinculaciones()">üîç Buscar</button>
        </div>

        <div id="contenedor-resultados" style="display:none;">
            <table style="width:100%; border-collapse: collapse; font-size:0.95rem;">
                <thead>
                    <tr style="background:#f2f2f2; text-align:left; color:#555;">
                        <th style="padding:10px; border-bottom:2px solid #ddd;">C√≥digo Barra (UPC/EAN)</th>
                        <th style="padding:10px; border-bottom:2px solid #ddd;">Asociado al SKU</th>
                        <th style="padding:10px; border-bottom:2px solid #ddd; text-align:center;">Eliminar</th>
                    </tr>
                </thead>
                <tbody id="tabla-body-resultados">
                    </tbody>
            </table>
            
            <div id="msg-sin-resultados" style="display:none; text-align:center; padding:20px; background:#fff3cd; color:#856404; margin-top:10px; border-radius:5px;">
                ‚ö†Ô∏è No se encontraron vinculaciones aprendidas para este c√≥digo.
            </div>
        </div>
    </div>
</div>
    </div>
</div>

<script>
    // --- MODAL FULL ---
    function abrirModalFull() { 
        document.getElementById('modal-full').style.display = 'block'; 
        document.getElementById('full-archivo').value = ''; // Limpiar input anterior
    }
    
    function cerrarModalFull() { document.getElementById('modal-full').style.display = 'none'; }
    
    function confirmarFull() {
        const fileInput = document.getElementById('full-archivo');
        const btn = document.getElementById('btn-confirmar-full');

        if (fileInput.files.length === 0) {
            alert("‚ö†Ô∏è Por favor, seleccion√° un archivo Excel o CSV.");
            return;
        }

        const formData = new FormData();
        formData.append('archivo_full', fileInput.files[0]);

        // UI Feedback
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥ Procesando...";
        btn.disabled = true;

        fetch('/admin/cargar-envio-full', { 
            method: 'POST', 
            body: formData 
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                alert("‚úÖ Archivo recibido correctamente.\n" + d.message);
                cerrarModalFull();
                // Aqu√≠ podr√≠amos recargar la p√°gina o mostrar resultados
            } else {
                alert("‚ùå Error: " + d.error);
            }
        })
        .catch(e => {
            console.error(e);
            alert("Error de conexi√≥n con el servidor.");
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    // --- SUBIR DOCS ---
    function subirDocumentos(btn) {
        const id = btn.getAttribute('data-id');
        const origen = btn.getAttribute('data-origen');
        const fileEti = document.getElementById(`file-eti-${id}`).files[0];
        
        const formData = new FormData();
        formData.append('orden_id', id);

        if (!fileEti) { alert("‚ö†Ô∏è Falta la Etiqueta de Env√≠o."); return; }
        formData.append('etiqueta_pdf', fileEti);

        if (origen === 'TN') {
            const fileFac = document.getElementById(`file-fac-${id}`).files[0];
            if (!fileFac) { alert("‚ö†Ô∏è TiendaNube requiere subir tambi√©n la Factura."); return; }
            formData.append('factura_pdf', fileFac);
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥ Subiendo...";
        btn.disabled = true;

        if(!confirm("¬øConfirmar carga? La orden volver√° al Operador con prioridad.")) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }

        fetch('/ordenes/admin/subir-docs', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if(d.success) { alert("‚úÖ Documentos cargados. Orden liberada."); window.location.reload(); }
            else { alert("Error: " + d.error); btn.innerHTML = originalText; btn.disabled = false; }
        })
        .catch(e => { alert("Error de conexi√≥n"); btn.innerHTML = originalText; btn.disabled = false; });
    }

    // --- MAESTROS ---
    async function importarDatos(tipo) {
        if(!confirm('¬øImportar DBF de ' + tipo.toUpperCase() + '?')) return;
        try {
            const res = await fetch('/ordenes/importar-' + tipo, { method: 'POST' });
            const data = await res.json();
            alert(data.mensaje || (data.success ? '‚úÖ Importaci√≥n Exitosa' : '‚ùå Error'));
        } catch(e) { alert('Error conexi√≥n'); }
    }

    // --- ETIQUETA MANUAL (MULTI-ARCHIVO) ---
    function subirEtiquetaManual(btn) {
        const ordenId = btn.getAttribute('data-id');
        const fileInput = document.getElementById(`file-eti-${ordenId}`);

        // Verificamos si hay archivos seleccionados
        if (!fileInput || !fileInput.files.length) { 
            alert("‚ö†Ô∏è Debes adjuntar al menos una etiqueta PDF."); 
            return; 
        }

        if (!confirm(`¬øAdjuntar ${fileInput.files.length} etiqueta(s) y devolver la orden al operario?`)) return;

        const formData = new FormData();
        formData.append('orden_id', ordenId);
        
        // RECORREMOS TODOS LOS ARCHIVOS Y LOS AGREGAMOS CON EL MISMO NOMBRE CLAVE 'etiquetas'
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('etiquetas', fileInput.files[i]);
        }

        btn.disabled = true; btn.innerText = "‚è≥ Uniendo y Subiendo...";

        fetch('/admin/subir-etiqueta-manual', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.success) { 
                alert("‚úÖ Etiquetas unificadas y cargadas. Orden devuelta."); 
                window.location.reload(); 
            }
            else { 
                alert(d.error || "Error"); 
                btn.disabled = false; 
                btn.innerText = "üè∑Ô∏è ADJUNTAR ETIQUETA Y DEVOLVER"; 
            }
        })
        .catch(() => { 
            alert("Error de red"); 
            btn.disabled = false; 
            btn.innerText = "üè∑Ô∏è ADJUNTAR ETIQUETA Y DEVOLVER"; 
        });
    }

    // --- ELIMINAR ORDEN (FUNCI√ìN ARREGLADA) ---
    function eliminarOrden(id, cliente) {
        if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de ELIMINAR la orden de ${cliente}?`)) return;
        
        const formData = new FormData();
        formData.append('orden_id', id);

        fetch('/admin/eliminar-orden', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) { window.location.reload(); }
            else { alert("‚ùå Error: " + data.error); }
        });
    }

    function desvincularSku(ordenId, sku) {
        if (!confirm(`‚ö†Ô∏è PELIGRO: ¬øEst√°s seguro de BORRAR la fila del SKU ${sku} de esta orden?\nEsto no se puede deshacer.`)) return;

        const formData = new FormData();
        formData.append('orden_id', ordenId);
        formData.append('sku', sku);

        fetch('/ordenes/admin/desvincular-sku', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.success) { 
                alert("‚úÖ SKU eliminado correctamente."); 
                window.location.reload(); 
            } else { 
                alert("‚ùå Error: " + (d.error || "No se pudo borrar")); 
            }
        })
        .catch(e => alert("Error de conexi√≥n con el servidor"));
    }

    // --- NUEVO: GESTI√ìN DE C√ìDIGOS (SCANNER) ---
    function abrirModalCorreccion() {
        document.getElementById('modal-correccion').style.display = 'block';
        // Reseteamos la vista
        document.getElementById('contenedor-resultados').style.display = 'none';
        document.getElementById('input-gestion-codigo').value = '';
        // Ponemos el cursor en el input autom√°ticamente
        setTimeout(() => document.getElementById('input-gestion-codigo').focus(), 100);
    }

    function buscarVinculaciones() {
        const query = document.getElementById('input-gestion-codigo').value.trim();
        if (!query) return;

        // Indicador de carga visual
        const tablaBody = document.getElementById('tabla-body-resultados');
        tablaBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px;">Buscando... ‚è≥</td></tr>';
        document.getElementById('contenedor-resultados').style.display = 'block';
        document.getElementById('msg-sin-resultados').style.display = 'none';

        const formData = new FormData();
        formData.append('query', query);

        fetch('/admin/consultar-asociaciones', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert("Error: " + data.error);
                return;
            }
            renderizarResultados(data.resultados);
            // Volvemos a enfocar el input por si quiere seguir escaneando
            document.getElementById('input-gestion-codigo').focus();
        })
        .catch(e => {
            console.error(e);
            alert("Error de conexi√≥n con el servidor");
        });
    }

    function renderizarResultados(lista) {
        const tbody = document.getElementById('tabla-body-resultados');
        const msg = document.getElementById('msg-sin-resultados');
        
        tbody.innerHTML = ''; // Limpiar tabla

        if (lista.length === 0) {
            msg.style.display = 'block'; // Mostrar mensaje amarillo
            return;
        }

        msg.style.display = 'none';

        // Crear una fila por cada resultado
        lista.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:10px; border-bottom:1px solid #eee; font-family:monospace; font-size:1.1rem; color:#d35400;">
                    ${item.codigo_barra}
                </td>
                <td style="padding:10px; border-bottom:1px solid #eee; font-weight:bold; color:#2c3e50;">
                    ${item.sku}
                </td>
                <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">
                    <button onclick="eliminarVinculacion('${item.codigo_barra}')" 
                            style="background:#c0392b; color:white; border:none; border-radius:4px; padding:5px 10px; cursor:pointer; font-weight:bold;"
                            title="Eliminar esta asociaci√≥n">
                        X
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function eliminarVinculacion(codigo) {
        if(!confirm(`‚ö†Ô∏è ¬øSeguro que quer√©s que el sistema OLVIDE la asociaci√≥n del c√≥digo:\n\n${codigo} ?`)) return;

        const formData = new FormData();
        formData.append('codigo_barra', codigo);

        fetch('/admin/borrar-asociacion-codigo', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if(d.success) {
                // Si se borr√≥ bien, volvemos a buscar para refrescar la lista
                buscarVinculaciones(); 
            } else {
                alert("‚ùå Error: " + d.error);
            }
        })
        .catch(e => alert("Error de conexi√≥n"));
    }
    // --- NUEVO: SUBIDA DESGLOSADA (BULTOS SEPARADOS) ---
    function guardarEtiquetasDesglosadas(ordenId, cantidadBultos) {
        // Seleccionamos todos los inputs de archivo de esa orden espec√≠fica
        const inputs = document.querySelectorAll(`.input-etiqueta-bulto[data-orden="${ordenId}"]`);
        const formData = new FormData();
        formData.append('orden_id', ordenId);
        
        let archivosEncontrados = 0;

        inputs.forEach(inp => {
            const idx = inp.getAttribute('data-index');
            // Si el usuario seleccion√≥ un archivo en este input
            if (inp.files.length > 0) {
                // Lo agregamos con clave √∫nica: etiqueta_0, etiqueta_1, etc.
                formData.append(`etiqueta_${idx}`, inp.files[0]);
                archivosEncontrados++;
            }
        });

        if (archivosEncontrados === 0) {
            alert("‚ö†Ô∏è No has seleccionado ning√∫n archivo para subir.");
            return;
        }

        // Advertencia si sube menos etiquetas que bultos
        if (archivosEncontrados < cantidadBultos) {
            if(!confirm(`‚ö†Ô∏è Solo cargaste ${archivosEncontrados} de ${cantidadBultos} etiquetas.\n¬øEnviar as√≠? (Los bultos sin etiqueta no se podr√°n imprimir en el pickeo)`)) return;
        } else {
            if(!confirm("¬øConfirmar carga de etiquetas y devolver orden al operario?")) return;
        }

        // Enviamos al backend
        fetch('/admin/subir-etiquetas-desglosadas', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                alert("‚úÖ Etiquetas guardadas correctamente.");
                window.location.reload();
            } else {
                alert("‚ùå Error del servidor: " + d.error);
            }
        })
        .catch(e => alert("Error de red o conexi√≥n"));
    }
</script>
{% endblock %}