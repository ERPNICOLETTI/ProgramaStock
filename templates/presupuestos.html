{% extends "base.html" %}
{% block content %}

<style>
    body {
        background: #f3f4f6;
    }

    .grid-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
        max-width: 1300px;
        margin: 0 auto;
    }

    .panel {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, .04);
        margin-bottom: 20px;
    }

    .panel-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 15px;
        color: #2c3e50;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 10px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #7f8c8d;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 2px solid #dfe6e9;
        border-radius: 6px;
        font-size: 15px;
    }

    /* SEARCH */
    .search-box {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .search-box input {
        flex: 1;
        font-size: 18px;
        font-weight: 600;
        padding: 14px;
        border: 2px solid #3498db;
        border-radius: 6px;
    }

    .row-item {
        display: grid;
        grid-template-columns: 120px 1fr 100px 90px;
        align-items: center;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        gap: 10px;
        border: 1px solid #e9ecef;
    }

    .sku {
        font-family: monospace;
        font-size: 13px;
        font-weight: bold;
        background: #eef1f4;
        padding: 4px 8px;
        border-radius: 6px;
        text-align: center;
    }

    .desc {
        font-weight: 600;
        font-size: 14px;
    }

    .price {
        font-weight: 800;
        color: #0d6efd;
        text-align: right;
    }

    .btn-add {
        background: #2ecc71;
        color: white;
        border: none;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    /* CART */
    .cart-item {
        display: grid;
        grid-template-columns: 40px 1fr 80px 30px;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }

    .cart-item input[type="number"] {
        width: 50px;
        padding: 4px;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .cart-total {
        margin-top: 20px;
        font-size: 24px;
        font-weight: 900;
        text-align: right;
        color: #27ae60;
    }

    .btn-generate {
        width: 100%;
        background: #e74c3c;
        color: white;
        font-size: 18px;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        transition: 0.2s;
    }

    .btn-generate:hover {
        background: #c0392b;
    }

    /* MODALS */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #7f8c8d;
    }

    .calc-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }

    .calc-btn {
        padding: 10px;
        border: 1px solid #bdc3c7;
        background: #ecf0f1;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .calc-btn:hover {
        background: #dfe6e9;
    }

    .calc-btn.action {
        background: #3498db;
        color: white;
        border-color: #2980b9;
    }

    @media (max-width: 900px) {
        .grid-layout {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="grid-layout py-4">

    <!-- LEFT COLUMN -->
    <div>
        <div class="panel">
            <div class="panel-title">üìù Datos del Cliente</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre / Raz√≥n Social *</label>
                    <input type="text" id="cliente_nombre" placeholder="Ej. Juan P√©rez" autofocus>
                </div>
                <div class="form-group">
                    <label>Localidad / Direcci√≥n</label>
                    <input type="text" id="cliente_localidad" placeholder="Ej. Puerto Madryn">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>CUIT / DNI</label>
                    <input type="text" id="cliente_cuit" placeholder="XX-XXXXXXXX-X">
                </div>
                <div class="form-group">
                    <label>Condici√≥n de Pago</label>
                    <select id="cliente_condicion">
                        <option>Efectivo / Transferencia</option>
                        <option>Cuenta Corriente</option>
                        <option>Tarjeta 3 Cuotas</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">üîç Buscar Productos</div>
            <div class="search-box">
                <input id="buscador" placeholder="Escanear o escribir producto‚Ä¶">
            </div>
            <div id="results"></div>
        </div>
    </div>

    <!-- RIGHT COLUMN (CART) -->
    <div>
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="panel-title" style="margin:0; border:none; padding:0;">üõí Detalle de Presupuesto</div>
                <button
                    style="background:#f39c12; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:bold; font-size:12px;"
                    onclick="abrirHistorial()">üìú Ver Historial</button>
            </div>
            <div style="border-top:2px solid #ecf0f1; margin: 10px 0;"></div>
            <div id="cart_items">
                <div style="text-align:center; color:#95a5a6; padding: 20px;">El presupuesto est√° vac√≠o.</div>
            </div>

            <div class="cart-total" id="cart_total_display">$ 0.00</div>

            <button class="btn-generate" onclick="generarPDF()">üìÑ Generar PDF</button>
        </div>
    </div>

</div>

<!-- MODAL AJUSTE PRECIO -->
<div id="modalAjuste" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close" onclick="cerrarAjuste()">‚úñ</button>
        <h3 id="modalAjusteTitle" style="margin-top:0;">Ajustar Precio</h3>
        <p style="color:#7f8c8d; font-size:14px;">Modifique el precio con un ajuste fijo ($) o un porcentaje de
            descuento/recargo (%).</p>

        <div style="margin-bottom: 15px; background:#f8f9fa; padding:10px; border-radius:6px; font-weight:bold;">
            Precio Base S/Ajus: $<span id="lblPrecioBase"></span>
        </div>

        <div class="calc-row">
            <div>
                <label style="font-size:13px; font-weight:bold;">Ajuste Fijo ($)</label>
                <input type="number" id="calcMonto" class="form-control" style="width:100%; padding:8px;"
                    placeholder="Ej: -500 o 1000">
            </div>
            <div>
                <label style="font-size:13px; font-weight:bold;">Porcentaje (%)</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="calcPorc" class="form-control" style="width:100%; padding:8px;"
                        placeholder="Ej: -10 o 21">
                    <button class="calc-btn action" onclick="aplicarPorcentaje()">Aplicar %</button>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button
                style="flex:1; padding:10px; background:#2ecc71; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;"
                onclick="guardarAjuste()">Guardar Ajuste</button>
            <button
                style="flex:1; padding:10px; background:#e74c3c; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;"
                onclick="limpiarAjuste()">Limpiar Ajuste</button>
        </div>
    </div>
</div>

<!-- MODAL HISTORIAL -->
<div id="modalHistorial" class="modal-overlay">
    <div class="modal-content" style="max-width:600px;">
        <button class="modal-close" onclick="document.getElementById('modalHistorial').style.display='none'">‚úñ</button>
        <h3 style="margin-top:0;">üìú Historial de Presupuestos</h3>
        <p style="color:#7f8c8d; font-size:14px; margin-bottom:15px;">Listado de los √∫ltimos 50 presupuestos generados.
        </p>

        <div id="listaHistorial" style="display:flex; flex-direction:column; gap:10px;">
            <!-- Renderizado din√°mico -->
        </div>
    </div>
</div>

<script>
    let carrito = [];
    let t = null;

    let itemIdxEdit = -1;

    document.getElementById("buscador").addEventListener("keyup", e => {
        clearTimeout(t);
        if (e.key === "Enter") buscar();
        t = setTimeout(() => { if (document.getElementById("buscador").value.length > 2) buscar(); }, 400);
    });

    function buscar() {
        const q = document.getElementById("buscador").value.trim();
        if (q.length < 2) return;

        fetch(`/stock/api/buscar?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(d => {
                const c = document.getElementById("results");
                c.innerHTML = "";
                if (!d.success) return;

                d.resultados.slice(0, 15).forEach(p => {
                    // Guardar producto en string seguro para pasarlo al boton
                    const prodData = encodeURIComponent(JSON.stringify(p));
                    c.innerHTML += `
                <div class="row-item">
                    <div class="sku">${p.sku}</div>
                    <div class="desc">${p.descripcion}</div>
                    <div class="price">$${p.precio_final.toLocaleString("es-AR")}</div>
                    <button class="btn-add" onclick="agregarAlCarrito('${prodData}')">AGREGAR</button>
                </div>`;
                });
            });
    }

    function agregarAlCarrito(dataStr) {
        const p = JSON.parse(decodeURIComponent(dataStr));

        // Ver si ya existe
        const exist = carrito.find(x => x.codigo === p.sku);
        if (exist) {
            exist.cant += 1;
        } else {
            carrito.push({
                codigo: p.sku,
                desc: p.descripcion,
                precio: p.precio_final,
                cant: 1,
                ajus: 0
            });
        }
        document.getElementById("buscador").value = "";
        document.getElementById("results").innerHTML = "";
        document.getElementById("buscador").focus();
        renderCarrito();
    }

    function actualizarCant(index, val) {
        carrito[index].cant = parseFloat(val) || 1;
        renderCarrito();
    }

    function eliminar(index) {
        carrito.splice(index, 1);
        renderCarrito();
    }

    function renderCarrito() {
        const c = document.getElementById("cart_items");
        let total = 0;

        if (carrito.length === 0) {
            c.innerHTML = '<div style="text-align:center; color:#95a5a6; padding: 20px;">El presupuesto est√° vac√≠o.</div>';
            document.getElementById("cart_total_display").innerText = "$ 0.00";
            return;
        }

        c.innerHTML = "";
        carrito.forEach((item, idx) => {
            const sub = (item.precio + item.ajus) * item.cant;
            total += sub;

            c.innerHTML += `
            <div class="cart-item">
                <input type="number" step="0.1" min="0.1" value="${item.cant}" onchange="actualizarCant(${idx}, this.value)">
                <div style="font-weight:600; line-height:1.2;">${item.desc}<br><small style="color:#7f8c8d;">${item.codigo}</small></div>
                <div style="text-align:right; font-weight:bold;">
                    $ ${(item.precio + item.ajus).toLocaleString("es-AR", { minimumFractionDigits: 2 })}
                    <button style="border:none;background:none;cursor:pointer;font-size:12px;" onclick="abrirAjuste(${idx})" title="Ajustar Precio">‚úèÔ∏è</button>
                    ${item.ajus !== 0 ? `<br><small style="color:${item.ajus > 0 ? '#e74c3c' : '#27ae60'};font-size:10px;">${item.ajus > 0 ? '+' : ''}${item.ajus}</small>` : ''}
                </div>
                <button style="border:none; background:transparent; color:#e74c3c; cursor:pointer;" onclick="eliminar(${idx})">‚ùå</button>
            </div>
        `;
        });

        document.getElementById("cart_total_display").innerText = "$ " + total.toLocaleString("es-AR", { minimumFractionDigits: 2 });
    }

    function generarPDF() {
        const cliente = document.getElementById("cliente_nombre").value.trim();
        if (!cliente) {
            alert("Por favor, ingrese el nombre del cliente.");
            document.getElementById("cliente_nombre").focus();
            return;
        }

        if (carrito.length === 0) {
            alert("El presupuesto est√° vac√≠o.");
            return;
        }

        const payload = {
            cliente: document.getElementById("cliente_nombre").value,
            localidad: document.getElementById("cliente_localidad").value,
            cuit: document.getElementById("cliente_cuit").value,
            condicion: document.getElementById("cliente_condicion").value,
            items: carrito
        };

        const btn = document.querySelector(".btn-generate");
        btn.innerText = "‚åõ Generando...";
        btn.disabled = true;

        fetch('/presupuestos/api/generar-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(d => {
                btn.innerText = "üìÑ Generar PDF";
                btn.disabled = false;

                if (d.success) {
                    window.open(d.url, '_blank');
                    // Opcional: limpiar carrito despu√©s de generar
                    // carrito = []; renderCarrito(); document.getElementById("cliente_nombre").value="";
                } else {
                    alert("Error: " + d.error);
                }
            })
            .catch(e => {
                btn.innerText = "üìÑ Generar PDF";
                btn.disabled = false;
                alert("Error de conexi√≥n");
            });
    }

    // FUNCIONES AJUSTE PRECIO
    function abrirAjuste(idx) {
        itemIdxEdit = idx;
        const item = carrito[idx];
        document.getElementById("modalAjusteTitle").innerText = "Ajustar: " + item.desc.substring(0, 20) + "...";
        document.getElementById("lblPrecioBase").innerText = item.precio.toLocaleString("es-AR", { minimumFractionDigits: 2 });

        document.getElementById("calcMonto").value = item.ajus === 0 ? "" : item.ajus;
        document.getElementById("calcPorc").value = "";
        document.getElementById("modalAjuste").style.display = "flex";
    }

    function cerrarAjuste() {
        document.getElementById("modalAjuste").style.display = "none";
    }

    function aplicarPorcentaje() {
        const p = parseFloat(document.getElementById("calcPorc").value);
        if (isNaN(p)) return;
        const item = carrito[itemIdxEdit];
        const calcAjus = (item.precio * (p / 100)).toFixed(2);
        document.getElementById("calcMonto").value = calcAjus;
    }

    function guardarAjuste() {
        const val = parseFloat(document.getElementById("calcMonto").value) || 0;
        if (itemIdxEdit > -1) {
            carrito[itemIdxEdit].ajus = val;
            renderCarrito();
        }
        cerrarAjuste();
    }

    function limpiarAjuste() {
        if (itemIdxEdit > -1) {
            carrito[itemIdxEdit].ajus = 0;
            renderCarrito();
        }
        cerrarAjuste();
    }

    // FUNCIONES HISTORIAL
    function abrirHistorial() {
        document.getElementById('modalHistorial').style.display = 'flex';
        document.getElementById('listaHistorial').innerHTML = '<div style="text-align:center;">Cargando...</div>';

        fetch('/presupuestos/api/historial')
            .then(r => r.json())
            .then(d => {
                const c = document.getElementById('listaHistorial');
                c.innerHTML = "";
                if (!d.success || d.archivos.length === 0) {
                    c.innerHTML = '<div style="color:#7f8c8d; text-align:center;">No hay presupuestos guardados.</div>';
                    return;
                }

                d.archivos.forEach(f => {
                    c.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid #eee; border-radius:6px;">
                    <div>
                        <div style="font-weight:bold; font-size:14px; color:#2c3e50;">P-${f.name.replace('presupuesto_', '').replace('.pdf', '')}</div>
                        <div style="font-size:12px; color:#7f8c8d;">üìÖ ${f.date}</div>
                    </div>
                    <div>
                        <a href="${f.url}" target="_blank" style="text-decoration:none; padding:6px 12px; background:#3498db; color:white; border-radius:4px; font-weight:bold; font-size:12px;">üìÑ Abrir</a>
                    </div>
                </div>
            `;
                });
            })
            .catch(e => {
                document.getElementById('listaHistorial').innerHTML = '<div style="color:#e74c3c;">Error al cargar.</div>';
            });
    }
</script>

{% endblock %}